<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Admin - Data Pelanggan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f6f7fb; }
    .sidebar {
      height: 100vh; width: 230px; position: fixed;
      background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .sidebar a { display: block; padding: 12px 20px; color: #333; text-decoration: none; }
    .sidebar a:hover { background-color: #f0f0f0; }
    .content { margin-left: 230px; padding: 20px; }
    .card-stats {
      border: none; border-radius: 15px; color: white; padding: 25px;
    }
    .purple { background: linear-gradient(45deg,#8e2de2,#4a00e0); }
    .blue { background: linear-gradient(45deg,#2193b0,#6dd5ed); }
    .orange { background: linear-gradient(45deg,#ff9966,#ff5e62); }
    .profile { display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
    .profile img { border-radius: 50%; width: 40px; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h5 class="text-center mt-3">Dashboard Admin</h5>
    <a href="#">Dashboard</a>
    <a href="#">Components</a>
    <a href="#">UI Elements</a>
    <a href="#">Form Stuff</a>
    <a href="#">Data Table</a>
    <a href="#">Icons</a>
    <a href="#">Extras</a>
  </div>

  <!-- Main Content -->
  <div class="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Dashboard</h3>
      <div class="profile">
        <input class="form-control" type="text" placeholder="Search project..." style="width:200px;">
        <img src="https://i.pravatar.cc/40" alt="Profile">
        <span>Success Awaken Amador</span>
      </div>
    </div>

    <!-- Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card card-stats purple">
          <h5>Stock Total</h5>
          <h3 id="stockTotal">Rp0</h3>
          <p>Increased by 50%</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card card-stats blue">
          <h5>Total Profit</h5>
          <h3 id="totalProfit">Rp0</h3>
          <p>Increased by 50%</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card card-stats orange">
          <h5>Unique Visitors</h5>
          <h3 id="uniqueVisitors">0</h3>
          <p>Increased by 30%</p>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Data Pelanggan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input type="hidden" id="editId">
              <div class="mb-3">
                <label class="form-label">Nama Perusahaan</label>
                <input type="text" class="form-control" id="editCompany" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Nama Depan</label>
                <input type="text" class="form-control" id="editFirstName" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Nama Belakang</label>
                <input type="text" class="form-control" id="editLastName" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Kota</label>
                <input type="text" class="form-control" id="editCity" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-primary" onclick="updateCustomer()">Simpan</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Data Pelanggan</h5>
          <button class="btn btn-primary btn-sm" onclick="exportToExcel()">
            <i class="fas fa-download me-1"></i> Export Excel
          </button>
        </div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Perusahaan</th>
                <th>Nama</th>
                <th>Kota</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="dataTable">
              <tr><td colspan="5" class="text-center text-muted">Loading data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    async function loadCustomers() {
      try {
        const res = await fetch('http://localhost/php-crud-api/api.php/records/customers');
        const data = await res.json();

        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = '';

        data.records.forEach(customer => {
          const row = `
            <tr>
              <td>${customer.id}</td>
              <td>${customer.company}</td>
              <td>${customer.first_name} ${customer.last_name}</td>
              <td>${customer.city}</td>
              <td>
                <button class="btn btn-sm btn-primary me-1" onclick="editCustomer(${customer.id}, '${customer.company}', '${customer.first_name}', '${customer.last_name}', '${customer.city}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });

        // Update dashboard stats
        document.getElementById('uniqueVisitors').innerText = data.records.length;
        document.getElementById('stockTotal').innerText = 'Rp' + (data.records.length * 1000000).toLocaleString();
        document.getElementById('totalProfit').innerText = 'Rp' + (data.records.length * 250000).toLocaleString();

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('dataTable').innerHTML =
          '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data</td></tr>';
      }
    }

    function editCustomer(id, company, firstName, lastName, city) {
      document.getElementById('editId').value = id;
      document.getElementById('editCompany').value = company;
      document.getElementById('editFirstName').value = firstName;
      document.getElementById('editLastName').value = lastName;
      document.getElementById('editCity').value = city;
      editModal.show();
    }

    async function updateCustomer() {
      const id = document.getElementById('editId').value;
      const data = {
        company: document.getElementById('editCompany').value,
        first_name: document.getElementById('editFirstName').value,
        last_name: document.getElementById('editLastName').value,
        city: document.getElementById('editCity').value
      };

      try {
        const response = await fetch(`http://localhost/php-crud-api/api.php/records/customers/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          showAlert('Data berhasil diupdate!', 'success');
          editModal.hide();
          loadCustomers();
        } else {
          throw new Error('Gagal mengupdate data');
        }
      } catch (error) {
        showAlert('Gagal mengupdate data: ' + error.message, 'danger');
      }
    }

    async function deleteCustomer(id) {
      if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
        try {
          const response = await fetch(`http://localhost/php-crud-api/api.php/records/customers/${id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            showAlert('Data berhasil dihapus!', 'success');
            loadCustomers();
          } else {
            throw new Error('Gagal menghapus data');
          }
        } catch (error) {
          showAlert('Gagal menghapus data: ' + error.message, 'danger');
        }
      }
    }

    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 3000);
    }

    function exportToExcel() {
      const table = document.querySelector('table');
      const html = table.outerHTML;
      const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
      const link = document.createElement('a');
      link.download = 'data_pelanggan.xls';
      link.href = url;
      link.click();
    }

    // Initial load
    loadCustomers();
  </script>

</body>
</html>
